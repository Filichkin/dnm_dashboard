# Интеграция функциональности по регионам в DNM Dashboard

## Выполненные изменения

### 1. **Новые SQL-скрипты с группировкой по регионам**
- `dnm_script_age_0_5_by_region.sql` - для возрастной группы 0-5 лет
- `dnm_script_age_0_10_by_region.sql` - для возрастной группы 0-10 лет

### 2. **Обновленные Python функции**

#### В `database/queries.py`:
- Добавлен параметр `group_by_region` в функцию `get_dnm_data()`
- Создана новая функция `get_dnm_data_by_region()`
- Логика передачи параметров: для запросов `by_region` передаются только `selected_year` и `selected_region`

#### В `app/functions.py`:
- Добавлена функция `load_region_data()` - загружает данные по региону выбранного дилера
- Добавлена функция `create_region_models_chart()` - создает линейный график по моделям в регионе
- Обновлена функция `create_charts_container()` - добавлен новый график по регионам

#### В `app/dnm.py`:
- Обновлен основной callback `update_dashboard()` для интеграции новой функциональности
- Добавлена логика: при выборе конкретного дилера автоматически загружаются данные по его региону

### 3. **Логика работы**

1. **При выборе Mobis Code:**
   - Система автоматически определяет регион дилера через `get_region_by_mobis_code()`
   - Загружаются данные по всем моделям в этом регионе
   - Создается дополнительный линейный график "Models Performance in Region"

2. **Линейный график показывает:**
   - Total RO Cost по моделям
   - Labor Hours по моделям  
   - Labor Hours per Car по моделям
   - RO/UIO Ratio по моделям

3. **Условия отображения:**
   - График по регионам отображается только при выборе конкретного дилера (не 'All')
   - Если данных по региону нет, отображается сообщение "Нет данных по региону"

### 4. **Средние значения по регионам**

Новые запросы вычисляют следующие средние значения для каждой модели в каждом регионе:

- **Total Profit** (`avg_total_ro_cost_by_model_region`)
- **Labor Hours** (`avg_labor_hours_0_5_by_model_region` / `avg_labor_hours_0_10_by_model_region`)
- **Labor Hours per Car** (`avg_aver_labor_hours_per_vhc_by_model_region`)
- **RO Cost Ratio (RO/UIO)** (`avg_ro_ratio_of_uio_5y_by_model_region` / `avg_ro_ratio_of_uio_10y_by_model_region`)

### 5. **Использование**

```python
# Получение данных с группировкой по регионам
df = get_dnm_data_by_region(
    selected_year=2024,
    age_group='0-5Y',  # или '0-10Y'
    selected_region='All'  # или конкретный регион
)
```

### 6. **Результат**

Теперь при выборе конкретного дилера в дашборде:
1. Отображаются стандартные графики по выбранному дилеру
2. **Дополнительно** отображается линейный график по всем моделям в регионе этого дилера
3. Пользователь может сравнивать показатели выбранного дилера с общими показателями по региону

## Файлы изменены:
- `SQL/dnm_script_age_0_5_by_region.sql` (новый)
- `SQL/dnm_script_age_0_10_by_region.sql` (новый)
- `database/queries.py` (обновлен)
- `app/functions.py` (обновлен)
- `app/dnm.py` (обновлен)
- `SQL/README_region_queries.md` (новый)
